{template 'web/_header'}
{template 'tabs'}

{if $operation=='display'}
        <form action="./index.php" method="get" class="form-horizontal" role="form" id="form1">
            <input type="hidden" name="c" value="site" />
            <input type="hidden" name="a" value="entry" />
            <input type="hidden" name="m" value="manor_shop" />
            <input type="hidden" name="do" value="plugin" />
            <input type="hidden" name="p" value="coupon" />
            <input type="hidden" name="method" value="coupon" />
            <input type="hidden" name="op" value="display" />
            
<div class="panel panel-info">
    <div class="panel-heading">筛选</div>
    <div class="panel-body">

            <div class="form-group">
              
            <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">优惠券名称</label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                    <input type="text" class="form-control"  name="keyword" value="{$_GPC['keyword']}" placeholder='可搜索优惠券名称'/> 
                </div>
            </div>
                  <div class="form-group">
                   <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">组</label>
                    <div class="col-sm-9 col-xs-12">
            <select name='catid' class='form-control'>
                <option value=''></option>
                {loop $category $k $c}
                    <option value='{$k}' {if $_GPC['catid']==$k}selected{/if}>{$c['name']}</option>
                      {/loop}
            </select>
                      
                    </div>
         </div>
              <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">类型</label>
              <div class="col-sm-8 col-lg-9 col-xs-12">
                    <select name='type' class='form-control'>
                        <option value=''></option>
                        <option value='0' {if $_GPC['type']=='0'}selected{/if}>购物</option>
                        <option value='1' {if $_GPC['type']=='1'}selected{/if}>充值</option>
                        <option value='2' {if $_GPC['type']=='2'}selected{/if}>劵码</option>
                        <option value='3' {if $_GPC['type']=='3'}selected{/if}>返券</option>
                    </select>
                  </div>
               
                </div>
    <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">领取中心是否显示</label>
              <div class="col-sm-8 col-lg-9 col-xs-12">
                    <select name='gettype' class='form-control'>
                        <option value=''></option>
                        <option value='0' {if $_GPC['gettype']=='0'}selected{/if}>不显示</option>
                        <option value='1' {if $_GPC['gettype']=='1'}selected{/if}>显示</option>
                    </select>
                  </div>
               
                </div>
                  <div class="form-group">
                    <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">创建时间</label>
                    <div class="col-sm-7 col-lg-9 col-xs-12">
                        <div class="col-sm-2">
                            <label class='radio-inline'>
                                <input type='radio' value='0' name='searchtime' {if $_GPC['searchtime']=='0'}checked{/if}>不搜索
                            </label> 
                             <label class='radio-inline'>
                                <input type='radio' value='1' name='searchtime' {if $_GPC['searchtime']=='1'}checked{/if}>搜索
                            </label>
                     </div>
                        {php echo tpl_form_field_daterange('time', array('starttime'=>date('Y-m-d', $starttime),'endtime'=>date('Y-m-d ', $endtime)),true);}
                    </div>
                </div>
 
<div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label"></label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                       <button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
            <input type="hidden" name="token" value="{$_W['token']}" />
                    
                </div>
            </div>    
   
    </div>
</div>
</div>
</form>
<form action="./index.php" method="get" class="form-horizontal" role="form" id="form2">
    <input type="hidden" name="c" value="site" />
    <input type="hidden" name="a" value="entry" />
    <input type="hidden" name="m" value="manor_shop" />
    <input type="hidden" name="do" value="plugin" />
    <input type="hidden" name="p" value="coupon" />
    <input type="hidden" name="method" value="coupon" />
    <input type="hidden" name="op" value="display" />
    <div class="panel panel-default">
    <div class="panel-heading">总数:{$total} <small>排序数字越大越靠前</small></div>
    <div class="panel-body">
        <table class="table table-hover table-responsive">
            <thead class="navbar-inner" >
                <tr>
                     <th style='width:50px;'>ID</th>
                     <th style="width:80px;">排序</th>
                     <th>优惠券名称</th>
 <th >使用条件/优惠</th>
          <th >已使用/已发出/剩余数量</th>
          <th>领取中心</th>
          <th >口令玩法人数/猜中人数</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {loop $list $row}
                <tr>
                      <td>{$row['id']}</td>
                      <td>
               {ifp 'coupon.coupon.edit'}
                           <input type="text" class="form-control" name="displayorder[{$row['id']}]" value="{$row['displayorder']}">
                        {else}
                           {$row['displayorder']}
                        {/if}
                        </td>
                
            <td>
                {if $row['coupontype']==0}
                    <label class='label label-success'>购物</label>
                {else if $row['coupontype'] == 1}
                <label class='label label-warning'>充值</label>
                {else if $row['coupontype'] == 2}
                <label class='label label-warning'>劵码</label>
                {else if $row['coupontype'] == 3}
                <label class='label label-warning'>返券优惠劵</label>
                {/if}
                     {if !empty($row['catid'])}
                     <label class='label label-primary'>{$category[$row['catid']]['name']}</label>
                     {/if}
                     <br/>{$row['couponname']}
                      </td>
                      <td>{if $row['enough']>0}
                          <label class="label label-danger">满{$row['enough']}可用</label>
                          {else}
                            <label class="label label-warning">不限</label>
                          {/if}
                     
                          <br/>{if $row['backtype']==0}
                          立减 {$row['deduct']} 元
                          {else if $row['backtype']==1}
                          打 {$row['discount']} 折
                          {else if $row['backtype']==2}
                          {if $row['backmoney']>0}返 {$row['backmoney']} 余额;{/if}
                          {if $row['backcredit']>0}返 {$row['backcredit']} 积分;{/if}
                          {if $row['backredpack']>0}返 {$row['backredpack']} 红包;{/if}
                          {/if}
                     </td>
                     
                    <td>
                                            {ifp 'coupon.log.view'}
                                            {if $row['coupontype'] == 2}
                                            <a href="{php echo $this->createPluginWebUrl('coupon/gen',array('coupon'=>$row['id']))}">
                                                {$row['usetotal']} / {$row['gettotal']} / {if $row['total']==-1}无限数量{else}{php echo $row['total'] -  $row['gettotal']}{/if}
                                            </a>
                                            {else}
                                            <a href="{php echo $this->createPluginWebUrl('coupon/log',array('coupon'=>$row['id']))}">
                                                 {$row['usetotal']} / {$row['gettotal']} / {if $row['total']==-1}无限数量{else}{php echo $row['total'] -  $row['gettotal']}{/if}
                                            </a>
                                            {/if}
                                            {else}
                                             {$row['usetotal']} / {$row['gettotal']} / {if $row['total']==-1}无限数量{else}{php echo $row['total'] -  $row['gettotal']}{/if}
                                            {/if}
                                      
                     <td>{if $row['gettype']==0}
                         <label class="label label-default">不显示</label>
                         {else}
                         
                         {if $row['credit']>0 || $row['money']>0}
                         {if $row['credit']>0}<label class='label label-primary'>{$row['credit']} 积分</label><br/>{/if}
                         {if $row['money']>0}<label class='label label-danger'>{$row['money']} 现金</label><br/>{/if}
                         {else}
                         <label class='label label-warning'>免费</label>
                         {/if}
                     {/if}
                     </td>
                     <td>{$row['pwdjoins']} / {$row['pwdoks']}</td>
                    <td>{php echo date('Y-m-d',$row['createtime'])}</td>
                    <td style="position:relative">
                        <a href="javascript:;" data-url="{php echo $this->createPluginMobileUrl('coupon/detail', array('id' => $row['id']))}"  title="复制连接" class="btn btn-default btn-sm js-clip"><i class="fa fa-link"></i></a>
                        
                         {ifp 'coupon.coupon.edit'} 
                              <a class='btn btn-default btn-sm' href="{php echo $this->createPluginWebUrl('coupon/coupon/post',array('id' => $row['id'], 'type'=>$row['coupontype']));}" title="编辑" ><i class='fa fa-edit'></i></a>
                             
                        {/if}
                        {ifp 'coupon.coupon.delete'} 
                              <a class='btn btn-default  btn-sm' href="{php echo $this->createPluginWebUrl('coupon/coupon/delete',array('id' => $row['id']));}" title="删除" onclick="return confirm('确定要删除该优惠券吗？');"><i class='fa fa-remove'></i></a>
                             
                        {/if}
                        
                       {ifp 'coupon.coupon.send'} 
                              <a  class='btn btn-primary  btn-sm' href="{php echo $this->createPluginWebUrl('coupon/send',array('couponid' => $row['id']));}" title="发放优惠券" ><i class='fa fa-send'></i></a>
                            
                        {/if}
                             </ul>
                       </div>

               
                    </td>
                </tr>
                {/loop}
            </tbody>
        </table>
        {$pager}
    </div>
    <div class='panel-footer'>
                               {ifp 'article.page.edit'}
                          <input name="submit" type="submit" class="btn btn-primary" value="提交排序">
                        {/if}
        {ifp 'coupon.coupon.add'}                   
                  <a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'post'))}"><i class='fa fa-plus'></i> 添加购物优惠券</a>
        <a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'post','type'=>1))}"><i class='fa fa-plus'></i> 添加充值优惠券</a>
        <a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'post','type'=>2))}"><i class='fa fa-plus'></i> 生成优惠券码</a>
        <a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'post','type'=>3))}"><i class='fa fa-plus'></i> 添加返券优惠券</a>

        <a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'ticket','type'=>4))}"><i class='fa fa-plus'></i> 添加订单裂变券</a>
        {/if}
    </div>
</div>
                 </form>

{else if  $operation=='ticket'}

<form {ife 'coupon.coupon.edit' $item}action="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'ticket','type'=>4))}" method='post'{/if} class='form-horizontal'>

  <input type="hidden" name="id" value="{$item['id']}">
    <div class='panel-body'>
        <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">裂变券名称</label>
               <div class="col-sm-5">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="fissionname" class="form-control" value="{$item['fissionname']}"  />
         <span class='help-block'>如20元订单平均券</span>
                    {else}
                    <div class='form-control-static'>{$item['fissionname']}</div>
                    {/if}
                </div>
        </div>

        <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">订单金额</label>
               <div class="col-sm-5">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="orderprice" class="form-control" value="{$item['orderprice']}"  />
         <span class='help-block'>用户订单的金额 根据订单金额发放优惠券</span>
                    {else}
                    <div class='form-control-static'>{$item['orderprice']}</div>
                    {/if}
                </div>
        </div>

        
<div class="form-group">
    <label class="col-xs-12 col-sm-3 col-md-2 control-label">随机券还是平均券</label>
    <div class="col-sm-9 col-xs-12" >
         
        <label class="radio-inline">
            <input type="radio" name="average" value="0" {if $item['average'] == 0}checked="true"{/if}  onclick="$('.gettype').hide();$('.quans').show()"/> 平均
        </label>
                  <label class="radio-inline">
            <input type="radio" name="average" value="1" {if $item['average'] == 1}checked="true"{/if}  onclick="$('.gettype').show();$('.quans').hide()" /> 随机 
        </label>
          <span class='help-block'>订单完成的优惠券类型</span>
        
          
    </div>
</div>

          <div class="form-group  gettype" {if $item['average']==0} style="display:none"{/if}>
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">请选择劵组</label>
                    <div class="col-sm-9 col-xs-12">
                        {ife 'coupon.coupon' $item}
                        <select name='catids' class='form-control'>
                            <option value=''>请选择</option>
                            {loop $category $k $c}
                            
                                <option value='{$k}' {if $item['catid']==$k}selected{/if}>{$c['name']}</option>
                             {/loop}
                        </select>
                        {else}
                             <div class='form-control-static'>{if empty($item['catid'])}暂时无卷组{else} {$category[$item['catid']]['name']}{/if}</div>
                        {/if}
                    </div>
         </div>          
      <div class='quans' {if $item['average']==1} style="display:none"{/if}>
        <div class="form-group ">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">请选择优惠券</label>
                    <div class="col-sm-9 col-xs-12">
                        {ife 'coupon.coupon' $item}
                        <select name='catid' class='form-control'>
                            <option value=''>请选择</option>
                          {loop $coupon $k $v}
                              
                                <option value='{$v['id']}' {if $item['catid']==$v['id']}selected{/if}>{$v['couponname']}</option>
                              {/loop}
                        </select>
                        <span class='help-block' >选取一个优惠券</span>
                        {else}
                             <div class='form-control-static'>{if empty($item['catid'])}暂时无优惠券{else} {$category[$item['catid']]['name']}{/if}</div>
                        {/if}

                    </div>

         </div>

          <div class="form-group ">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">发放数量</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="total" class="form-control" value="{$item['total']}"  />
                    <span class='help-block' >单笔订单发放优惠券数量，没有不能领取或发放,不能为负数</span>
                    {else}
                    <div class='form-control-static'>{if $item['total']==-1}无限数量{else}剩余 {$item['total']} 张{/if}</div>
                    {/if}
                </div>
          </div>
       </div>

     <div class="form-group ">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">福利有效时间</label>
                <div class="col-sm-9 col-xs-12">
                  
                    <input type="text" name="effective" class="form-control" value="{$item['effective']}"  />
                    <span class='help-block' >红包福利在订单详情页显示的时间,小时为单位</span>
                    
                </div>
          </div>
    
    <div class="form-group">
    <label class="col-xs-12 col-sm-3 col-md-2 control-label">状态</label>
    <div class="col-sm-9 col-xs-12" >
          {ife 'coupon.coupon' $item}
        <label class="radio-inline">
            <input type="radio" name="status" value="0" {if $item['status'] == 0}checked="true"{/if}  /> 开启
        </label>
                  <label class="radio-inline">
            <input type="radio" name="status" value="1" {if $item['status'] == 1}checked="true"{/if}  /> 关闭 
        </label>
          <span class='help-block'>裂变券的状态</span>
        
          {else} <div class='form-control-static'>
             {if $item['gettype']==1}可以{else}不可以{/if}
          </div>
          {/if}
     </div>
    </div>


          <div class="form-group"></div>
            <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                    <div class="col-sm-9 col-xs-12">
                         {ife 'coupon.coupon' $item}
                            <input type="submit" name="submit" value="提交" class="btn btn-primary col-lg-1"  />
                            <input type="hidden" name="token" value="{$_W['token']}" />
                        {/if}
                       <input type="button" name="back" onclick="href()" {ife 'coupon.coupon' $item}style='margin-left:10px;'{/if} value="订单裂变券列表" class="btn btn-default" />
                    </div>
            </div>    

        <input type="hidden" id="fiss" value="{php echo $this -> createPluginWebUrl('coupon/coupon', array('op' => 'fission'))}">

 </div>
</form>
   <script>
      
       function href(){
          list=$('#fiss').val();
         window.location.href=list;
    }

    $(function(){
    
    $('form').submit(function(){
      
      if($(':input[name=fissionname]').isEmpty()){
        Tip.focus($(':input[name=fissionname]'),'请输入裂变券名称!');
        return false;
      }
      
        if($(':input[name=orderprice]').isEmpty()){
          Tip.focus($(':input[name=orderprice]'),'请输入订单金额!');
          return false;
        }
       
       if($(':input[name=effective]').isEmpty()){
          Tip.focus($(':input[name=effective]'),'请输入红包有效时间!');
          return false;
        }
        // if($(':input[name=total]').isEmpty()){
        //   Tip.focus($(':input[name=total]'),'请输入发放数量!');
        //   return false;
        // }
     
      return true;
    })
    
  })

  </script>
{else if $operation==='sharecoupon'}
<a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'ticket','type'=>4))}"> 添加订单裂变券</a>

 <a class='btn btn-default' href="{php echo $this -> createPluginWebUrl('coupon/coupon', array('op' => 'fission'))}"> 订单裂变券列表 </a>

  <div class="panel-body">
        <table class="table table-hover table-responsive">
            <thead class="navbar-inner" > 
                <tr>
                     <th style='width:50px;'>ID</th>
                   
                     <th>订单号</th>
                     <th >裂变券名称</th>
                     <th >领取数量</th>
                     <th >剩余数量</th>
                     <th >分享人</th>
                     <th>分享时间</th>
                     <th>操作</th>
                </tr>
            </thead>
            <tbody>
                  {loop $share $row}
                <tr>
                     <td>{$row['id']}</td>
                     
                     <td>{$row['ordersn']}</td>
                     <td><label class='label label-success'>{$row['fissionname']}</label></td>
                     <td><label class='label label-warning'>{$row['receivenum']}</label></td>
                     <td><label class="label label-default">{$row['surplusnum']}</label></td>
                     <td><label class='label label-danger'>{$row['sharename']}</label></td>
                     <td> {php echo date('Y-m-d',$row['sharetime'])}</td>
                    
                    <td style="position:relative">
                        
                        {ifp 'coupon.coupon.delete'} 
                              <a class='btn btn-default  btn-sm' href="{php echo $this->createPluginWebUrl('coupon/coupon/deleteshare',array('id' => $row['id']));}" title="删除" onclick="return confirm('确定要删除该分享列表吗？');"><i class='fa fa-remove'></i></a>
                             
                        {/if}
                        
                    
                             </ul>
                       </div>

               
                    </td>
                </tr>
                {/loop}  
            </tbody>
        </table>
        {$pager}
    </div>


{else if $operation=='fission'}

 <a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'ticket','type'=>4))}"> 添加订单裂变券</a>

 <a class='btn btn-default' href="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'sharecoupon','type'=>4))}"> 裂变券分享列表</a>
<form {ife 'coupon.coupon.edit' $item}action="{php echo $this->createPluginWebUrl('coupon/coupon',array('op'=>'fission'))}" method='post'{/if} class='form-horizontal'>
  <div class="panel-body">
        <table class="table table-hover table-responsive">
            <thead class="navbar-inner" > 
                <tr>
                     <th style='width:50px;'>ID</th>
                     <th style="width:80px;">排序</th>
                     <th>裂变券名称</th>
                     <th >分享条件</th>
                     <th >类型</th>
                     <th >已发出</th>
                     <th>优惠券名称</th>
                     <th >单券可领取人数</th>
                     <th>裂变券领取有效期</th>
                     <th>创建时间</th>
                     <th>当前状态</th>
                     <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {loop $fission $row}
                <tr>
                     <td>{$row['id']}</td>
                     <td><input type="text" class="form-control" name="displayorder[{$row['id']}]" value="{$row['orders']}"></td>
                     <td><label class='label label-success'>{$row['fissionname']}</label></td>
                     <td> <label class="label label-danger">单笔订单满{$row['orderprice']}可用</label></td>
                     <td> {if $row['average']==0}<label class='label label-warning'>平均</label>{else} <label class='label label-primary'>随机</label>{/if}</td>
                     <td>{$row['grant']}</td>
                     <td>{$row['couponname']}</td>
                     <td>{$row['total']}</td>
                     <td>{$row['effective']}小时</td>
                     <td> {php echo date('Y-m-d',$row['createtime'])}</td>
                     <td>{if $row['status']==0} <label class='label label-warning'>开启</label>{else} <label class="label label-default">关闭</label>{/if}</td>
                    <td style="position:relative">
                        
                         {ifp 'coupon.coupon.edit'} 
                              <a class='btn btn-default btn-sm' href="{php echo $this->createPluginWebUrl('coupon/coupon/ticket',array('id' => $row['id']));}" title="编辑" ><i class='fa fa-edit'></i></a>
                             
                        {/if}
                        {ifp 'coupon.coupon.delete'} 
                              <a class='btn btn-default  btn-sm' href="{php echo $this->createPluginWebUrl('coupon/coupon/deletefission',array('id' => $row['id']));}" title="删除" onclick="return confirm('确定要删除该裂变券吗？');"><i class='fa fa-remove'></i></a>
                             
                        {/if}
                        
                    
                             </ul>
                       </div>

               
                    </td>
                </tr>
                {/loop}
            </tbody>
        </table>
        {$pager}
    </div>
    <div class='panel-footer'>
                               
                          <input name="submit" type="submit" class="btn btn-primary" value="提交排序"></div>

{else if $operation=='post'}

<form {ife 'coupon.coupon.edit' $item}action="" method='post'{/if} class='form-horizontal'>
    <input type="hidden" name="id" value="{$item['id']}">
    <input type="hidden" name="op" value="detail">
    <input type="hidden" name="c" value="site" />
    <input type="hidden" name="a" value="entry" />
    <input type="hidden" name="m" value="manor_shop" />
    <input type="hidden" name="p" value="coupon" />
    <input type="hidden" name="method" value="coupon" />
    <input type="hidden" name="op" value="post" />
    <input type="hidden" name="coupontype" value="{$_GPC['type']}" />
    <div class='panel panel-default'>
        <div class='panel-heading'>
            编辑{if $type==0}购物{else if $type==1}充值{else if $type==2}兑换码{else if $type==3}返券{/if}优惠券
        </div>
        
   <div class='panel-body'>
        <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">排序</label>
               <div class="col-sm-5">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="displayorder" class="form-control" value="{$item['displayorder']}"  />
         <span class='help-block'>数字越大越靠前</span>
                    {else}
                    <div class='form-control-static'>{$item['displayorder']}</div>
                    {/if}
                </div>
        </div>
     
            <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style='color:red'>*</span> 优惠券名称</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="couponname" class="form-control" value="{$item['couponname']}"  />
                    {else}
                    <input type="hidden" name="couponname" class="form-control" value="{$item['couponname']}"  />
                    <div class='form-control-static'>{$item['couponname']}</div>
                    {/if}
                </div>
        </div>
 
            
        <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">请选择劵组</label>
                    <div class="col-sm-9 col-xs-12">
                        {ife 'coupon.coupon' $item}
                        <select name='catid' class='form-control'>
                            <option value=''></option>
                            {loop $category $k $c}
                                <option value='{$k}' {if $item['catid']==$k}selected{/if}>{$c['name']}</option>
                             {/loop}
                        </select>
                        {else}
                             <div class='form-control-static'>{if empty($item['catid'])}暂时无卷组{else} {$category[$item['catid']]['name']}{/if}</div>
                        {/if}
                    </div>
         </div>
                              <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">缩略图</label>
                    <div class="col-sm-9 col-xs-12">
                        {ife 'coupon.coupon' $item}
                        {php echo tpl_form_field_image('thumb', $item['thumb'])}
                        {else}
                        <input type="hidden" name="thumb" value="{$item['thumb']}"/>
                        {if !empty($item['thumb'])}
                        <a href='{php echo tomedia($item['thumb'])}' target='_blank'>
                           <img src="{php echo tomedia($item['thumb'])}" style='width:100px;border:1px solid #ccc;padding:1px' />
                        </a>
                        {/if}
                        {/if}
                    </div>
                </div>
         <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">使用条件</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="enough" class="form-control" value="{$item['enough']}"  />
                    <span class='help-block' >{if empty($type)}消费{else}充值{/if}满多少可用, 空或0 不限制</span>
                    {else}
                    <div class='form-control-static'>{if $item['enough']>0}满 {$item['enough']} 可用 {else}不限制{/if}</div>
                    {/if}
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">使用时间限制</label>
                
                    {ife 'coupon.coupon.edit' $item}
                    <div class="col-sm-3">
                    <div class='input-group'>
                        <span class='input-group-addon'>
                             <label class="radio-inline" style='margin-top:-5px;' ><input type="radio" name="timelimit" value="0" {if $item['timelimit']==0}checked{/if}>获得后</label>
                        </span>
                   
                     <input type='text' class='form-control' name='timedays' value="{$item['timedays']}" />
                     <span class='input-group-addon'>天内有效(空为不限时间使用)</span>
                      </div>
                     </div>
                    
                     <div class="col-sm-2">
                    <div class='input-group'>
                        <span class='input-group-addon'>
                             <label class="radio-inline" style='margin-top:-5px;' ><input type="radio" name="timelimit" value="1" {if $item['timelimit']==1}checked{/if}>日期</label>
                        </span>
                         {php echo tpl_form_field_daterange('time', array('starttime'=>date('Y-m-d', $starttime),'endtime'=>date('Y-m-d', $endtime)));}
                          <span class='input-group-addon'>内有效</span>
                      </div>
                     </div>
                       {else}
                       <div class="col-sm-9 col-xs-12">
                      <div class='form-control-static'>
                          {if $item['timelimit']==0}
                          {if !empty($item['timedays'])}获得后 {$item['timedays']} 天内有效{else}不限时间{/if}
                          {else}
                          {php echo date('Y-m-d',$starttime)} - {php echo date('Y-m-d',$endtime)}  范围内有效
                          {/if}</div>
                      </div>
                    {/if}
              
            </div>
            {if empty($type) || in_array($type , array(2,3))}
            {template 'coupon/consume'}
            {else}
            {template 'coupon/recharge'}
            {/if}

<div class="form-group">
    <label class="col-xs-12 col-sm-3 col-md-2 control-label">领券中心是否可获得</label>
    <div class="col-sm-9 col-xs-12" >
          {ife 'coupon.coupon' $item}
        <label class="radio-inline">
            <input type="radio" name="gettype" value="0" {if $item['gettype'] == 0}checked="true"{/if}  onclick="$('.gettype').hide()"/> 不可以
        </label>
                  <label class="radio-inline">
            <input type="radio" name="gettype" value="1" {if $item['gettype'] == 1}checked="true"{/if} onclick="$('.gettype').show()" /> 可以
        </label>
          <span class='help-block'>会员是否可以在领券中心直接领取或购买</span>
        
          {else} <div class='form-control-static'>
             {if $item['gettype']==1}可以{else}不可以{/if}
          </div>
          {/if}
    </div>
</div>
         <div class="form-group gettype" {if $item['gettype']!=1}style="display:none"{/if}>
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                        <div class="col-sm-6">
                              {ife 'coupon.coupon' $item}
                            <div class="input-group">
              <span class="input-group-addon">每个限领</span>
              <input type='text' class='form-control' value="{$item['getmax']}" name='getmax'/>
                                <span class="input-group-addon">张 消耗</span>
                             <input type='text' class='form-control' value="{$item['credit']}" name='credit'/>
                             <span class="input-group-addon">积分 + 花费</span>
                                <input type='text' class='form-control' value="{$item['money']}" name='money'/>
                              <span class="input-group-addon">元&nbsp;&nbsp;
                                  <label class="checkbox-inline" style='margin-top:-8px;'>
                                    <input type="checkbox" name='usecredit2' value="1" {if $item['usecredit2']==1}checked{/if} /> 优先使用余额支付
                                </label>
                              </span></div>
                              <span class="help-block">每人限领，空不限制，领取方式可任意组合，可以单独积分兑换，单独现金兑换，或者积分+现金形式兑换, 如果都为空，则可以免费领取</span>
                                                       {else}
                             <div class='form-control-static'>消耗 {$item['credit']} 积分 花费 {$item['money']} 元现金</div>
                             {/if} 
                             </div>
      
                    </div>
        　 {if $type != 2}
         <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">发放总数</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="total" class="form-control" value="{$item['total']}"  />
                    <span class='help-block' >优惠券总数量，没有不能领取或发放,-1 为不限制张数</span>
                    {else}
                    <div class='form-control-static'>{if $item['total']==-1}无限数量{else}剩余 {$item['total']} 张{/if}</div>
                    {/if}
                </div>
   </div>
        {/if}
     
　     </div>
        　
　     <div class='panel-heading'>
            使用说明
        </div>
        <div class='panel-body'>
            
                <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">是否使用统一说明 </label>
                <div class="col-sm-9 col-xs-12">
                   {ife 'coupon.coupon' $item}
                   <label class="radio-inline" >
                    <input type="radio" name="descnoset" value="0" {if $item['descnoset'] == 0}checked="true"{/if} /> 使用
                </label>
               
                         <label class="radio-inline"'>
                    <input type="radio" name="descnoset" value="1" {if $item['descnoset'] == 1}checked="true"{/if} /> 不使用
                </label>
                   <span class='help-block'>统一说明在<a href="{php echo $this->createPluginWebUrl('coupon/set')}" target='_blank'>【基础设置】</a>中设置，如果使用统一说明，则在优惠券说明前面显示统一说明</span>
                        {else}
                        
                        <div class='form-control-static'>
                          {if $item['descnoset']==0}
                          使用
                          {else if $item['descnoset']==1}
                         不使用
                          {else}
                          {/if}
                      </div>
                        {/if}
                </div>
            </div>
            
                        
            <div class="form-group">
    <label class="col-xs-12 col-sm-3 col-md-2 control-label">使用说明</label>
    <div class="col-sm-9 col-xs-12">
                  {ife 'coupon.coupon' $item}
                            {php echo tpl_ueditor('desc',$item['desc'])}
                            {else}
                            <textarea id='desc' style='display:none'>{$item['desc']}</textarea>
                            <a href='javascript:preview_html("#desc")' class="btn btn-default">查看内容</a>
                            {/if}
    </div>
        </div>   </div>
               <div class='panel-heading'>
            推送消息 (发放或用户从领券中心获得后的消息推送，如果标题为空就不推送消息)
        </div>
            <div class='panel-body'>
            
                
                  <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">推送标题</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="resptitle" class="form-control" value="{$item['resptitle']}"  />
          <span class="help-block">变量 [nickname] 会员昵称 [total] 优惠券张数</span>
                    {else}
                    <div class='form-control-static'>{$item['resptitle']}</div>
                    {/if}
                </div>
            </div>
                  <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">推送封面</label>
                    <div class="col-sm-9 col-xs-12">
                        {ife 'coupon.coupon' $item}
                        {php echo tpl_form_field_image('respthumb', $item['respthumb'])}
                        {else}
                        <input type="hidden" name="respthumb" value="{$item['respthumb']}"/>
                        {if !empty($item['thumb'])}
                        <a href='{php echo tomedia($item['respthumb'])}' target='_blank'>
                           <img src="{php echo tomedia($item['respthumb'])}" style='width:100px;border:1px solid #ccc;padding:1px' />
                        </a>
                        {/if}
                        {/if}
                    </div>
                </div>
                
                    <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">推送说明</label>
                <div class="col-sm-9 col-xs-12">
                     {ife 'coupon.coupon' $item}
                    <textarea name="respdesc" class='form-control'>{$item['respdesc']}</textarea>
                      <span class="help-block">变量 [nickname] 会员昵称 [total] 优惠券张数</span>
                       {else}
                      <div class='form-control-static'>{$item['respdesc']}</div>
                    {/if}
                </div>
            </div>
                  <div class="form-group">
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">推送连接</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="respurl" class="form-control" value="{$item['respurl']}"  />
                    <span class='help-block'>消息推送点击的连接，为空默认为优惠券详情</span>
                    {else}
                    <div class='form-control-static'>{$item['respurl']}</div>
                    {/if}
                </div>
            </div>  
            </div>
{if !in_array($type, array(2,3))}
    <div class='panel-heading'>
            口令玩法 (用户发送关键词猜取优惠券)
        </div>
    <div class='panel-body'>
        
        <div class="form-group">
    <label class="col-xs-12 col-sm-3 col-md-2 control-label">是否开启口令玩法</label>
    <div class="col-sm-9 col-xs-12" >
          {ife 'coupon.coupon' $item}
        <label class="radio-inline">
            <input type="radio" name="pwdopen" value="0" {if $item['pwdopen'] == 0}checked="true"{/if} onclick="$('.couponkey').hide()"  /> 关闭
        </label>
                  <label class="radio-inline">
            <input type="radio" name="pwdopen" value="1" {if $item['pwdopen'] == 1}checked="true"{/if} onclick="$('.couponkey').show()"  /> 开启
        </label>
          {else} 
     <div class='form-control-static'>
             {if $item['pwdopen']==1}开启{else}关闭{/if}
          </div>
          {/if}
    </div>
</div>
        
    <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">开始活动关键词</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="pwdkey" class="form-control" value="{$item['pwdkey']}"  />
          <span class="help-block">从平台获取优惠券的回复关键词,如果设置关键词为空，则不使用口令玩法，如果更换关键词，则表示开启另一轮活动</span>
                    {else}
                    <div class='form-control-static'>{$item['pwdkey']}</div>
                    {/if}
                </div>
            </div>
     <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">口令集</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                      <textarea name="pwdwords" class='form-control'>{$item['pwdwords']}</textarea>
          <span class="help-block">可以多个口令, 用半角逗号隔开,口令不要与其他系统关键词重复</span>
                    {else}
                    <div class='form-control-static'>{$item['pwdwords']}</div>
                    {/if}
                </div>
            </div>
        
         <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">每人猜测机会</label>
                <div class="col-sm-9 col-xs-12">
                     {ife 'coupon.coupon' $item}
                    <input name="pwdtimes" class='form-control' value='{$item['pwdtimes']}'>
            <span class="help-block">每人机会，空或0为不限制 </span>
                       {else}
                      <div class='form-control-static'>{if empty($item['pwdtimes'])}不限制{else}{$item['pwdtimes']}次{/if}</div>
                      
                    {/if}
                </div>
            </div>
         <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">提示语</label>
                <div class="col-sm-9 col-xs-12">
                     {ife 'coupon.coupon' $item}
                    <textarea name="pwdask" class='form-control'>{$item['pwdask']}</textarea>
            <span class="help-block">默认: 请输入优惠券口令: </span>
            <span class='help-block'>变量: [nickname] 会员昵称 [couponname] 优惠券名称 [times] 已猜测次数 [lasttimes] 剩余猜测次数</span>
                       {else}
                      <div class='form-control-static'>{if empty($item['pwdask'])}请输入优惠券口令:{else}{$item['pwdask']}{/if}</div>
                      
                    {/if}
                </div>
            </div>
    
       <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">猜中提示语</label>
                <div class="col-sm-9 col-xs-12">
                     {ife 'coupon.coupon' $item}
                       <textarea name="pwdsuc" class='form-control'>{$item['pwdsuc']}</textarea>
             <span class="help-block">默认: 恭喜你，猜中啦！优惠券已发到您账户了!</span>
             <span class='help-block'>变量: [nickname] 会员昵称 [couponname] 优惠券名称 [times] 已猜测次数 [lasttimes] 剩余猜测次数</span>
                       {else}
                      <div class='form-control-static'>{if empty($item['pwdsuc'])}恭喜你，猜中啦！优惠券已发到您账户了!{else}{$item['pwdsuc']}{/if}</div>
                      
                    {/if}
                </div>
            </div>
    
      <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">猜错提示语</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <textarea name="pwdfail" class='form-control'>{$item['pwdfail']}</textarea>
          <span class='help-block'>默认: 很抱歉，您猜错啦，继续猜~</span>
          <span class='help-block'>变量: [nickname] 会员昵称 [couponname] 优惠券名称 [times] 已猜测次数 [lasttimes] 剩余猜测次数</span>
                    {else}
                    <div class='form-control-static'>{if empty($item['pwdfail'])}很抱歉，您猜错啦，继续猜~{else}{$item['pwdfail']}{/if}</div>
          
                    {/if} 
                </div>
            </div>  
       <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">猜测次数超出限制提示</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                     <textarea name="pwdfull" class='form-control'>{$item['pwdfull']}</textarea>
          <span class='help-block'>默认: 很抱歉，您已经没有机会啦~</span>
          <span class='help-block'>变量: [nickname] 会员昵称 [couponname] 优惠券名称 [times] 已猜测次数 [lasttimes] 剩余猜测次数</span>
                    {else} 
                    <div class='form-control-static'>{if empty($item['pwdfull'])}很抱歉，您已经没有机会啦~{else}{$item['pwdfull']}{/if}</div>
                    {/if}
                </div>
            </div>  
         <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">退出口令</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                    <input type="text" name="pwdexit" class="form-control" value="{$item['pwdexit']}"  />
          <span class="help-block">如果设置有次数限制，用户继续猜了，可输入退出口令，默认为0</span>
                    {else}
                    <div class='form-control-static'>{$item['pwdexit']}</div>
                    {/if}
                </div>
            </div>
           <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">退出后提示</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                     <textarea name="pwdexitstr" class='form-control'>{$item['pwdexitstr']}</textarea>
           <span class='help-block'>默认: 好的，等待您下次来玩!</span>
          <span class='help-block'>变量: [nickname] 会员昵称 [couponname] 优惠券名称 [times] 已猜测次数 [lasttimes] 剩余猜测次数</span>
          
                    {else}
                    <div class='form-control-static'>{if empty($item['pwdexitstr'])}很好的，等待您下次来玩!{else}{$item['pwdexitstr']}{/if}</div>
                    {/if}
                </div>
            </div>
        
      <div class="form-group couponkey" {if empty($item['pwdopen'])}style="display:none"{/if}>
                <label class="col-xs-12 col-sm-3 col-md-2 control-label">已获得提示</label>
                <div class="col-sm-9 col-xs-12">
                    {ife 'coupon.coupon' $item}
                     <textarea name="pwdown" class='form-control'>{$item['pwdown']}</textarea>
          <span class='help-block'>默认: 您已经参加过啦,等待下次活动吧~</span>
          <span class='help-block'>变量: [nickname] 会员昵称 [couponname] 优惠券名称 [times] 已猜测次数 [lasttimes] 剩余猜测次数</span>
                    {else} 
                    <div class='form-control-static'>{if empty($item['pwdown'])}您已经参加过啦,等待下次活动吧~{else}{$item['pwdown']}{/if}</div>
                    {/if}
                </div>
            </div>   
            </div>
    {else if $type == 2}
    <div class='panel-heading'>
        兑换码设置 (用户领取时候要输入的劵码)
    </div>
    <div class='panel-body'>
        <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">是否系统自动生成</label>
            <div class="col-sm-9 col-xs-12">
                {if !isset($item['sys_gen'])}
                <label class="radio-inline">
                    <input type="radio" name="sys_gen" value="1" {if $item['sys_gen'] == 1 || !isset($item['sys_gen'])}checked="true"{/if}
                    onclick="$('.couponsys_genkey').hide();$('.gen_times').show()" /> 是
                </label>
                <label class="radio-inline">
                    <input type="radio" name="sys_gen" value="0" {if $item['sys_gen'] === 0}checked="true"{/if}
                    onclick="$('.couponsys_genkey').show();$('.gen_times').hide()" /> 否
                </label>
                <span class="help-block">一般为了避免外在的错误,建议选择系统自动生成劵码的方式,可以规避劵码重复等不必要问题</span>
                {else}
                <div class='form-control-static'>
                    <input type="hidden" name="sys_gen" value="{$item['sys_gen']}">
                    {if $item['sys_gen']==1}是{else}否{/if}
                </div>
                {/if}
            </div>
        </div>
        {if $_GPC['id']}
        <div class="form-group couponsys_genkey" {if !empty($item['sys_gen'])}style="display:none"{/if}>
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">已有劵码集</label>
            <div class="col-sm-9 col-xs-12">
                {if $item['sys_gen_text']}
                <div class='form-control-static'>
                    {$item['sys_gen_text']}
                </div>
                {else}
                <div class='form-control-static'>暂无</div>
                {/if}
            </div>
        </div>
{/if}
        <div class="form-group couponsys_genkey" {if !isset($item['sys_gen']) || $item['sys_gen'] ==1}style="display:none"{/if}>
            {if $_GPC['id']}
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">新增劵码集</label>
            {else}
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">劵码集</label>
            {/if}
            <div class="col-sm-9 col-xs-12">
                <textarea name="sys_gen_text" class='form-control'></textarea>
                <span class="help-block">可以多个劵码, 用半角逗号隔开</span>
            </div>
        </div>

        {if $_GPC['id'] && $item['sys_gen'] == 1}
        <div class="form-group gen_times">
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">已生成数量</label>
            <div class="col-sm-9 col-xs-12">
                <div class='form-control-static'>
                    {if $item['gen_times']>0}{$item['gen_times']}{else}0{/if}
                </div>
            </div>
        </div>
        {/if}
        <div class="form-group gen_times" {if !(isset($item['sys_gen'])) || ($_GPC['id'] && $item['sys_gen'] ==1) }style="display:block"{else} style="display:none"{/if}>
            {if $_GPC['id']}
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">新增数量</label>
            {else}
            <label class="col-xs-12 col-sm-3 col-md-2 control-label">生成数量</label>
            {/if}
            <div class="col-sm-9 col-xs-12">
                <input type="text" name="gen_times" class="form-control" />
                <span class="help-block">生成劵码数量,最小1个,生成后不可将数量减少,但是可对未使用的劵码进行单个删除</span>
            </div>
        </div>
    </div>
    {/if}

            <div class="form-group"></div>
            <div class="form-group">
                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                    <div class="col-sm-9 col-xs-12">
                         {ife 'coupon.coupon' $item}
                            <input type="submit" name="submit" value="提交" class="btn btn-primary col-lg-1"  />
                            <input type="hidden" name="token" value="{$_W['token']}" />
                        {/if}
                       <input type="button" name="back" onclick='history.back()' {ife 'coupon.coupon' $item}style='margin-left:10px;'{/if} value="返回列表" class="btn btn-default" />
                    </div>
            </div>


        </div>


    </div>   
   
</form>
<script language='javascript'>
    
    function showbacktype(type){
        if(type != 3) {
            $('.backtype').hide();
        }
        $('.backtype' + type).show();
    }
    function show_dan(obj){
       var val = $(obj).val();
        if(val == 0) {
            $('.show_dan').hide();
        } else {
            $('.show_dan').show();
        }
    }
    $(function(){
        
        $('form').submit(function(){
            
            if($(':input[name=couponname]').isEmpty()){
                Tip.focus($(':input[name=couponname]'),'请输入优惠券名称!');
                return false;
            }
            var backtype = $(':radio[name=backtype]:checked').val();
            if(backtype=='0'){
                if($(':input[name=deduct]').isEmpty()){
                    Tip.focus($(':input[name=deduct]'),'请输入立减多少!');
                    return false;
                }
            }else if(backtype=='1'){
                if($(':input[name=discount]').isEmpty()){
                    Tip.focus($(':input[name=discount]'),'请输入折扣多少!');
                    return false;
                }
            }else if(backtype=='2'){
                if($(':input[name=backcredit]').isEmpty() && $(':input[name=backmoney]').isEmpty() && $(':input[name=backredpack]').isEmpty()){
                    Tip.focus($(':input[name=backcredit]'),'至少输入一种返利!');
                    return false;
                }
            }else if(backtype=='3'){
                if($('#goods_ids').isEmpty()){
                    Tip.select($('#goods_ids'),'请选择一种单品商品作为优惠劵使用!');
                    return false;
                }
            }
            return true;
        })
        
    })
</script>
    
{/if}
{template 'web/_footer'}