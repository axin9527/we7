{template 'common/header'}
<title>{$set['name']}</title>
<script language="javascript" src="../addons/manor_shop/template/mobile/tangsheng/static/js/zquery.fly.min.js"></script>
<style type="text/css">
    *{box-sizing:border-box;}
    body {margin:0px; background:#eee; font-family:'微软雅黑'; -moz-appearance:none;}
    .top {overflow: hidden; position:relative;}
    .top .bgimg {height:auto; position:relative;}
    .top .bgimg img { width:100%; position: relative;display: block;}
    .top .list {position:absolute;right:10px;top:10px;height:35px; width:auto; line-height:50px; font-size:16px; text-align:right; color:#efefef; margin-right:10px;}
    .top .topbar {height:220px; width:100%; position:absolute; bottom:-30px; left:0px; z-index:2;}
    .top .topbar .logo {height:80px; width:80px; padding:4px; border:1px solid #fff; border-radius:45px; margin:auto;}
    .top .topbar .logo img {height:70px; width:70px; padding:4px; border:1px solid #fff; border-radius:70px; margin:auto;}
    .top .topbar .shop_name {height:30px; width:auto; background:rgba(0,0,0,0.1); padding:0px 15px; margin:10px auto; font-size:16px; color:#fff; line-height:30px; text-align:center; display:table; border-radius:15px;}
    .top .topbar .menu {height:45px; width:100%; background:rgba(0,0,0,0.3);}
    .top .topbar .menu .nav {height:40px; width:25%; padding-top:5px; float:left; text-align:center; font-size:12px; color:#fff;}
    .top .topbar .menu .navon {height:37px; border-bottom:3px solid #dd2322;}
    .top .topbar .menu .nav i {font-size:18px;}
    .top .tips {font-size: 12px;padding: 9px;padding-top: 11px;background: #f7efce;color: #666;text-align: left;width: 100%;}
    .top .tips .close{font-size: 16px;position: absolute;right: 8px;top: 9px;}
    .search_wrap{width: 100%;height: 42px;background:rgba(253,173,39,0.7);position: fixed;top: 0;padding-top:7px;z-index: 999;}
    .search {height:28px; width:75%; background:#ffe4a1; color:#2f2f2f; line-height:28px; font-size:0.85rem; text-align:center;border-radius: 14px;margin-left: 5%;float: left;}
    .search1 .go_back{padding: 6px 12px;float: left;position: absolute;line-height: 40px;}
    .city_location{width: 20%;padding:0 10px;text-align: center;line-height: 28px;color: #666;font-size: 14px;text-decoration: none;float: right}
    .city_location i{font-size: 16px;margin-right: 3px;}
    .title {height:34px; background:#fff url("../addons/manor_shop/template/mobile/default/static/images/title_bg.png") no-repeat center center; background-size:75%;font-size:15px; color:#6f6f6f; line-height:34px;text-align: center;}
    .title h3{width: 32%;height:100%;margin: 0 auto;}
    .title h3 img{float: left;width: 20px;margin-top: 7px;margin-left: 5px;}
    .title h3 p{float: left;width:75%;margin: 0;}
    .goods {height:auto; min-height:100px; width:100%; background:#f3f3f3; overflow:hidden;float:left;padding:7px 12px 0;}
    .goods .good {overflow:hidden;background:#fff;margin-bottom: 7px;position: relative;padding:20px 0 10px 28px;}
    .goods .good>img{width: 46px;position: absolute;left: -5px;top: -5px;}
    .goods .good .good_left,.goods .good .good_right{width: 50%;float: left;}
    .goods .good .img {width:100%;overflow:hidden;height: 90px;}
    .goods .good .img img {width:100%;height:100%;margin: 0 auto;display: block;}
    .goods .good .name {width:100%; font-size:0.95rem; line-height:20px; color:#000001; overflow:hidden;display: block;white-space: nowrap;  overflow: hidden; text-overflow: ellipsis;}
    .goods .good .sub_name {width:100%; font-size:0.85rem; line-height:20px; color:#ccc; overflow:hidden;display: block;white-space: nowrap;  overflow: hidden; text-overflow: ellipsis;}
    .goods .good .price {width:100%; color:#f03; font-size:14px;}
    .goods .good .original_price{text-decoration:line-through;font-size: 15px;color: #ff3366;margin:0;
        padding: 0;margin-top: 10px}
    .goods .good .magic_price{font-size: 0.8rem;color: #ff3366;font-weight: bold;margin: 0;
        padding:0;margin-top: -8px}
    .goods .good .magic_price span{font-size: 26px;}
    .copyright {height:40px; width:100%; text-align:center; line-height:30px; font-size:12px; color:#999; padding:10px 0 0; float: left;}
    /*.bottom_menu {height:50px; width:100%; background:#f90; position:fixed; bottom:0px; left:0px; z-index:1;}*/


    .banner {overflow:hidden;position:relative;height:auto;}
     .banner  .main_image{width:100%;position:relative;top:0;left:0;}
  .banner .main_image ul{}
  .banner .main_image li{float:left;}
  .banner .main_image li img{display:block;width:100%; }
  .banner .main_image li a{display:block;width:100%;}

    div.flicking_con{position:absolute;bottom:10px;z-index:1;width:100%;height:12px;}
    div.flicking_con .inner { width:100%;height:9px;text-align:center;}
    div.flicking_con a{position:relative; width:10px;height:9px;background:url('../addons/manor_shop/template/mobile/default/static/images/dot.png') 0 0 no-repeat;display:inline-block;text-indent:-1000px}
    div.flicking_con a.on{background-position:0 -9px}
    #index_loading { width:94%;color:#666;text-align: center;float:left; font-size:13px; height: 30px;}

    .class1 {background:#fff; border-top:1px solid #eee; border-bottom:1px solid #eee;overflow:hidden;}
.class1 .class2 { width:25%; float:left;}
.class1 .class2:active {background:#f7f7f7;}
.class1 .class2 .class3 {; width:80px; margin:auto;}
.class1 .class2 .class3 .ico {height:40px; width:40px; margin:10px 15px 10px 15px; line-height:40px; text-align:center; color:#fff; font-size:18px;}
.class1 .class2 .class3 .ico img { width:50px;height:50px;}
.class1 .class2 .class3 .text { width:80px; font-size:12px; color:#666666; text-align:center; line-height:30px;overflow:hidden;padding-bottom: 10px;}
.bgimg{padding:3px 3px;}
.bgimg img{display: block;width: 100%;}
.act_group{color: green;text-align: center;font-size: 0.85rem;width: 100%;float: left;}
.act_group .group_tiao{width: 28%;  height: 1px;margin: 3% 6%;padding: 0px;background-color: green;overflow: hidden; float: left;}
.hot_search{height: 38px;font-size:14px; padding:10px;}
.hot_search img{vertical-align:bottom;width: 15px}
    .search_con{background: #fff;height: 120px;padding: 16px 8px;font-size: 14px;color: #B9B9B9;overflow: scroll}
    .search_con span{border: 1px solid #ccc;padding: 7px 12px;margin: 7px;width: 27%;float: left; text-align: center;overflow: auto}
    .tips_tuijian{position: absolute;font-size: 12px;left: 6px;top: 4px; color: #fff;}
</style>
<div id='list_contanier'></div>
<div id='container' style="margin-top: 42px"></div>


<script id='tpl_index' type='text/html'>

    <div class="top">
        <%if advs.length>0%>
        <div class="banner">

            <%if advs.length>1%>
            <div class="flicking_con"><div class="inner">
                <%each advs as value index %>
                <a class="<%if index==0%>on<%/if%>" href="#@"><%index%></a>
                <%/each%>
                </div>
            </div>
            <%/if%>
            <div class="main_image" id='banner'>
                <ul>
                    <%each advs as adv %>
                    <li <%if adv.link%>onclick="location.href='<%adv.link%>'"<%/if%>> <img src="<%adv.thumb%>"></li>
                    <%/each%>
                </ul>
            </div>
        </div>
        <%/if%>

<!--        <div class="list" onclick="location.href='{php echo $this->createMobileUrl('shop/category')}'"><i class="fa fa-list"></i> 分类</div>-->
        <div class="search_wrap">
            <div class='search'><i class="fa fa-search" style="padding:7px;float: left;"></i> 搜索全部商品</div>
            <a href="{php echo $this->createMobileUrl('shop/city')}" class="city_location"><i class="fa fa-map-marker"></i><span id="gps_city">北京</span></a>
        </div>
    </div>

    <%if navigation.length > 0%>
    <!-- <div class="title">推荐分类</div> -->
    <div class="class1">
        <%each navigation as nav_val nav_key%>
        <a href="<%if !nav_val.url%>javascript:alert('暂未开放,敬请期待');<%else%><%nav_val.url%><%/if%>">
            <div class="class2">
                <div class="class3">
                    <div class="ico ico1"><img src='<%nav_val.thumb%>' /></div>
                    <div class="text"><%nav_val.name%></div>
                </div>
            </div>
        </a>
        <%/each%>
    </div>
    <%/if%>
    <div>公告：本平台春节放假时间是2017-01-20~2017-02-7，期间下单不发货。</div>
    <%if activity.length>0%>
    <div class="activity">
        <%each activity as value index %>
        <%if value.act_group%>
        <div class="act_group">
            <div class="group_tiao"></div>
            <div style="float: left;width: 20%;font-size: 14px;height: 28px;line-height: 12px;padding-top: 3px;"><%value.act_group%><br><span style="font-size: 12px"><%value.subtitle%></span></div>
            <div class="group_tiao" style="float: right;"></div>
        </div>
        <%/if%>
        <%if value.advurl%>
        <a href="<%value.advurl%>"><div class="bgimg"><img src="<%value.advimg%>"></div></a>
        <%else%>
        <a href="{php echo $this->createMobileUrl('shop/activity')}&id=<%value.id%>&op=detail"><div class="bgimg"><img src="<%value.advimg%>"></div></a>
        <%/if%>

        <%/each%>

    </div>
    <%/if%>
    <div class="act_group">
        <div class="group_tiao"></div>
        <div style="float: left;width: 20%;font-size: 14px;height: 28px;line-height: 13px">好鲜优选<br><span style="font-size: 12px">精品推荐</span></div>
        <div class="group_tiao" style="float: right;"></div>
    </div>
    <div class="goods">
        <div id='goods_container'></div>
    </div>

     <!--搜索-->
    <div class="search1">
        <div class="topbar1">
            <div class='right'>
                <button class="sub1"><i class="fa fa-times" style="color: #B9B9B9"></i></button>
                <div class="home1 to_search"><i class="fa fa-search" style="color: #B9B9B9"></i></div>
            </div>
            <span class="go_back home2"><i class="fa fa-angle-left fa-2" style="font-size: 20px;color: #797979;" aria-hidden="true"></i></span>
            <div class='left_wrap'>

                <div class='left'>
                    <input type="text" id='keywords' class="input1" value="{$hot_search[0]}" placeholder='搜索: 输入商品关键词'/>
                </div>
            </div>
        </div>
        <div class="hot_search">
            <img src="../addons/manor_shop/template/mobile/tangsheng/static/images/hot.png" alt="">
            <span>热门搜索</span>
        </div>
        <div class="search_con">
            {if $hot_search}
            {loop $hot_search $k $v}
            <span class="clear_hi">{$v}</span>
            {/loop}
            {/if}
        </div>
        <div class="hot_search">
            <img width="15px" src="../addons/manor_shop/template/mobile/tangsheng/static/images/search_history.png" alt="">
            搜索历史
        </div>
        <div class="search_con" id="search_history">

        </div>
        <div style="text-align: center;margin-top: 32px" id="clear_history">
            <img width="135px" src="../addons/manor_shop/template/mobile/tangsheng/static/images/clear_history.png" alt="">
        </div>
        <div id='search_container' class='result1'>
        </div>
    </div>

</script>

<script id='tpl_goods_list' type='text/html'>

    <%each goods as g%>
    <div class="good" data-goodsid='<%g.id%>'>
        <img src="../addons/manor_shop/template/mobile/tangsheng/static/images/good_icon2.png" />
        <%if g.istime==1%>
        <span class="tips_tuijian">秒杀</span>
        <%else if g.issendfree==1%>
        <span class="tips_tuijian">包邮</span>
        <%else if g.isrecommand==1%>
        <span class="tips_tuijian">推荐</span>
        <%else if g.ishot==1%>
        <span class="tips_tuijian">热销</span>
        <%/if%>

        <div class="good_left">
            <div class="name"><%g.title%></div>
            <div class="sub_name"><%g.sub_title%></div>
            <div class="price">
                <p class="original_price">
                    <%if g.productprice>0 && g.marketprice!=g.productprice%>￥<%g.productprice%><%/if%>
                </p>
                <p class="magic_price">惊爆价:￥<span><%g.marketprice%></span></p>
            </div>
        </div>
        <div class="good_right">
            <div class='img' data-goodsid="<%g.id%>"><img src="<%g.thumb%>"></div>
        </div>
        <div class="go_cart">
            <%if g.total>0 && g.status ==1%>
            <a class="btn-cart" data-id="<%g.id%>" onclick="index_add_cart(this)" href="javascript:void (0);">加入购物车</a>
            <%else if g.total<=0 && g.status ==1%>
            <a class="btn-grey" href="">补货中</a>
            <%else g.status ==0%>
            <a class="btn-grey" href="">已下架</a>
            <%/if%>
        </div>
    </div>
    <%/each%>

</script>
 <script id='tpl_search_list' type='text/html'>
     <ul>
     <%each list as value%>
        <li><i class="fa fa-angle-right"></i> <a href="{php echo $this->createMobileUrl('shop/detail')}&id=<%value.id%>"><%value.title%></a></li>
        <%/each%>
    </ul>
</script>
<script language='javascript'>
    var page = 1;
    var loaded = false;
    var stop = true;
    var scrolling = false;
    require(['core', 'tpl'], function (core, tpl) {
        core.json('shop/index', {}, function (json) {
            var result = json.result;

            $('#container').html(tpl('tpl_index', result));

            $('.nav').click(function () {
                $('.nav').removeClass('navon');
                $(this).addClass('navon');
                var op = $(this).data('op');
                if (op == 'all') {
                    location.href = core.getUrl('shop/list');
                } else if (op == 'discount') {
                    location.href = core.getUrl('shop/list', {isdiscount: 1});
                } else if (op == 'notice') {
                    location.href = core.getUrl('shop/notice');
                }
            });

            if (result.advs.length > 0) {

            //   $('.banner').height($('.main_image').find('img').height());

                require(['jquery','jquery.touchslider','swipe'], function ($) {


                    new Swipe($('#banner')[0], {
			speed:300,
			auto:4000,
			callback: function(){

                                 $(".flicking_con  .inner  a").removeClass("on").eq(this.index).addClass("on");
		}
	  });



                })
            }
            function getGoods(type) {

                core.json('shop/index', {'op': 'goods', page: page, 'city':localStorage.getItem('current_city')}, function (gjson) {
                    var result = gjson.result;
                    if (result.status == 0) {
                        core.message('服务器内部错误', core.getUrl('shop'), 'error');
                        return;
                    }
                    stop = true;
                    $('#index_loading').remove();
                    $('#goods_container').append(tpl('tpl_goods_list', result));
    $('.good img').each(function(){
                //$(this).height($(this).width()/2);
            })
                        $('.good img,.good .good_left').unbind('click').click(function(){
                            location.href = core.getUrl('shop/detail',{id:$(this).parent().data('goodsid') });
                        })

                    if (result.goods.length < result.pagesize && scrolling) {

                        $('#goods_container').append('<div id="index_loading">已经加载全部商品</div>');
                        loaded = true;
                        $(window).scroll = null;
                        return;
                    }



                    $(window).scroll(function () {

                        if (loaded) {
                            return;
                        }
                        totalheight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());
                        if ($(document).height() <= totalheight) {
                            if (stop == true) {
                                stop = false;scrolling=true;
                                $('#goods_container').append('<div id="index_loading"><i class="fa fa-spinner fa-spin"></i> 正在加载更多商品</div>');
                                page++;
                                getGoods('display');
                            }
                        }
                    });
                });
            }

                $('.search').click(function(){

                          $(".search1").animate({right:"0px"},100);
                           /*$('#keywords').unbind('keyup').keyup(function(){
                                   var keywords = $.trim( $(this).val());
                                   if(keywords==''){
                                       $('#search_container').html("");
                                       return;
                                   }
                                   core.json('shop/util',{op:'search',keywords:keywords,'city':local_city }, function (json) {
                                        var result = json.result;
                                        if(result.list.length>0){
                                           $('#search_container').html(tpl('tpl_search_list',result));
                                        }
                                        else{
                                           $('#search_container').html("");
                                            //core.tip.show('暂无数据');
                                        }

                                     }, true);
                           });*/
                           $('.search1 .to_search').unbind('click').click(function(){
                                   var keywords = $.trim( $('#keywords').val());
                                    if(keywords){
                                        write_search_history(keywords);
                                    }
                                   var url = core.getUrl('shop/list',{keywords:keywords});
                                   location.href=  url;
                            });
                            $('.search1 .sub1').unbind('click').click(function(){
                                   $('#keywords').val("");
                            });
                           $('.search1 .home2').unbind('click').click(function(){
                                $(".search1").animate({right:"-100%"},100);
                           });
                            $('#clear_history').unbind('click').click(function(){
                                if(confirm("确定清除搜索历史记录吗？"))
                                {
                                    clear_search_history();
                                }
                            });
                            $('.clear_hi').unbind('click').click(function(){
                                $('#keywords').val($(this).html());
                            });
                       });


            getGoods();
            $('#gps_city').html(localStorage.getItem('current_city'));
            $('.close').on('click', function () {
                $('.tips').hide();
            })
            get_search_history();
        }, true);
    });
    function write_search_history(val) {
        var old = localStorage.getItem('search_history');
        if(!old) {
            var old = [];
        } else {
            var old = JSON.parse(old);
        }
        if(old.indexOf(val) >= 0) {
            return;
        }
        old.push(val);
        localStorage.setItem('search_history', JSON.stringify(old));
    }
    function get_search_history() {
        var old = localStorage.getItem('search_history');
        var _html = "";
        if(!old){
            return;
        }
        var old = JSON.parse(old);
        for(var i=0;i<old.length;i++) {
            _html += '<span class="clear_hi">' + old[i] + '</span>';
        }
        $('#search_history').html(_html);
    }
    function clear_search_history() {
        localStorage.removeItem('search_history');
    }
    function index_add_cart(obj) {
        var i = 1;
        var j = 1;
        var top = $('.top').outerHeight();
        var class1 = $('.class1').outerHeight();
        var div_height = $('.goods').outerHeight();
        var good_height = $('.good').outerHeight();
        $('.good').each(function (k,v) {
           if($(v).data('goodsid') == $(obj).parent().parent().data('goodsid')) {
               return false;
           } else {
               i++;
           }
        });

        var start = {
            left: event.pageX-40,  //开始位置（必填）#fly元素会被设置成position: fixed
            top: top+class1+good_height*(i-1)-100,  //开始位置（必填）
        };
        var  start = {
            left: event.pageX,  //开始位置（必填）#fly元素会被设置成position: fixed
            top: event.clientY-40,  //开始位置（必填）
        };
        add_cart(obj, '', start);
    }

</script>
<script>

</script>
{php $show_copyright=true;$show_footer=true;$footer_current ='first'}
{template 'common/footer'}
