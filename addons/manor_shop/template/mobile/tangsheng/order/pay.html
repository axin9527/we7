{template 'common/header'}
<title>æ”¯ä»˜è®¢å•</title>
<style type="text/css">
    body {margin:0px; background:#efefef; font-family:'å¾®è½¯é›…é»‘'; -moz-appearance:none;}
    .order_main {height:auto; border-bottom:1px solid #f0f0f0; border-top:1px solid #f0f0f0; background:#fff;margin-top:10px;}
    .order_main .line {height:44px; margin:0 5px; border-bottom:1px solid #f0f0f0; line-height:44px;}
    .order_main .line .label { float:left;width:80px;}
    .order_main .line .info { float:right; width:100%; margin-left:-85px;text-align: right;overflow:hidden;height:44px;}
    .order_main .line .info .inner { color:#666;margin-left:85px;}
    .order_main .tip { color:#666; line-height:20px;padding:5px;font-size:13px; }

    .order_main .line .nav {height:22px; width:40px; background:#ccc; margin:10px 0px; float:right; border-radius:40px;}
    .order_main .line .on {background:#4ad966;}
    .order_main .line .nav nav {height:20px; width:20px; background:#fff; margin:1px; border-radius:20px;}
    .order_main .line .nav .on {margin-left:19px;}

    .order_sub1 {height:44px; margin:14px 5px; background:#31cd00; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
    .order_sub2 {height:44px; margin:14px 5px; background:#f49c06; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
    .order_sub3 {height:44px; margin:14px 5px;background:#e2cb04; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
    .order_sub4 {height:44px; margin:14px 5px; background:#18c0f7; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}

    .order_main1 {height:30px;padding:10px;border-bottom:1px solid #f0f0f0; border-top:1px solid #f0f0f0; background:#fff;text-align:center;margin-top:10px; }
    .order_sub5 {height:30px; width:35%;padding:5px 10px 5px 10px; border:1px solid #ccc; border-radius:4px; text-align:center; font-size:16px; line-height:30px; color:#333; }
    .order_sub6 {height:44px; margin:14px 5px; background:#07c4d0; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}

    .order_subc {height:44px; margin:14px 5px; background:#31cd00; border-radius:4px; text-align:center; font-size:16px; line-height:44px; color:#fff;}
    .qname{ width: 20px;font-size: 20px;word-wrap: break-word;letter-spacing: 20px;color: #fff;float: right;position: absolute;right:8%;font-weight: 500;top: 25%;}
    .coupon_item{height:auto;}
    .qcon{position: absolute;top: 8%;bottom:10%;max-width:80%;left: 7%;height: 80%;width: 68%;padding: 0px;border: 1px dashed #fff; border-radius: 5px;}
    .qgz1{text-align: center;font-size: 50px; color: #fff;font-weight: 500;line-height:50px;margin: 5px;}
    .qgz2{line-height: 20px; font-size: 12px;margin-left: 10px;color: #fff;font-weight: 500;}
</style>

<div id='container'></div>
<script id='tpl_order_info' type='text/html'>
    <input type='hidden' id='orderid' value="<%order.id%>"/>
    <div class="page_topbar">
        <a href="javascript:;" class="back" onclick="history.go(-2)"><i class="fa fa-angle-left"></i></a>
        <div class="title">æ”¯ä»˜è®¢å•</div>
    </div>
    <div class="order_main" >
        <div class="line"><div class="label">è®¢å•ç¼–å·</div><div class="info"><div class="inner"><%order.ordersn%></div></div></div>
        <div class="line"><div class="label">æ”¯ä»˜é‡‘é¢</div><div class="info"><div class="inner"><div style='color:#ff6600'>ï¿¥<span id="orderprice" price="<%order.price%>"><%order.price%></span>å…ƒ</div></div></div></div>
    </div>
    <%if order.price>0%>
    <%if wechat.success%><div class="button order_sub1">å¾®ä¿¡æ”¯ä»˜</div><%/if%>
    <%if alipay.success%><div class="button order_sub2" >æ”¯ä»˜å®æ”¯ä»˜</div><%/if%>

    <%if credit.success %>
    <%if order.couponid == 0%>
    <div class="button order_sub3">ä½™é¢æ”¯ä»˜(å½“å‰ä½™é¢:<%credit.current%>)</div>
    <input type="hidden" id="credit" value="<%credit.current%>" />
    <div class="button order_sub4" onclick="location.href='{php echo $this->createMobileUrl('member/recharge')}&returnurl=<%returnurl%>'">ä½™é¢å……å€¼</div>
    <%if credit.current<=0%>
    <!-- <div class="button order_sub4" onclick="location.href='{php echo $this->createMobileUrl('member/recharge')}&returnurl=<%returnurl%>'">è´¦æˆ·å……å€¼</div>-->
    <%/if%>
    <%/if%>
    <%/if%>

    <%/if%>

    <div class="button order_subc"  <%if order.price>0%>style="display:none"<%/if%>>ç¡®è®¤æ”¯ä»˜</div>
    <%if cash.success%><div class="button order_sub6" >è´§åˆ°ä»˜æ¬¾</div><%/if%>
</script>

<script id='tpl_order_pay' type='text/html'>
    <div class="page_topbar">
        <div class="title">æ”¯ä»˜æˆåŠŸ</div>
    </div>
    <%if address%>
    <img src="../addons/manor_shop/template/mobile/default/static/images/pay_ok.png" style="width:100%;" />
    <%/if%>
    <%if order.dispatchtype=='1' && order.isverify!='1'%>
    <img src="../addons/manor_shop/template/mobile/default/static/images/pay_carrier.png" style="width:100%;" />
    <%/if%>
    <%if order.isverify=='1'%>
    <img src="../addons/manor_shop/template/mobile/default/static/images/pay_verify.png" style="width:100%;" />
    <%/if%>
    <%if order.virtual!='0'%>
    <img src="../addons/manor_shop/template/mobile/default/static/images/pay_virtual.png" style="width:100%;" />
    <%/if%>
    <%if order.isvirtual=='1'%>
    <img src="../addons/manor_shop/template/mobile/default/static/images/pay_success.png?v=1" style="width:100%;" />
    <%/if%>
    <!-- æ–°ç‰ˆä¼˜æƒ åˆ¸å¼€å§‹-->
    <%if coupon%>
    <div class="coupon_content" style="position: relative">
        <%if coupon.coupon_goods_id>0%>
        <img src="../addons/manor_shop/plugin/coupon/template/mobile/default/images/yhq3.png" style="width:100%;" />
        <%else if coupon.backtype == 0 && coupon.enough<=0%>
        <img src="../addons/manor_shop/plugin/coupon/template/mobile/default/images/yhq2.png" style="width:100%;" />
        <%else if coupon.backtype == 0 && coupon.enough>0%>
        <img src="../addons/manor_shop/plugin/coupon/template/mobile/default/images/yhq1.png" style="width:100%;" />
        <%/if%>
        <div class="qcon">
            <div class="qgz1"><%if coupon.backpre%>ï¿¥<%/if%><%coupon.deduct%></div>
            <div class="qgz2"><%coupon.couponname%></div>
            <div class="qgz2">
                <%if coupon.timestr==''%>
                æ°¸ä¹…æœ‰æ•ˆ
                <%else%>
                <%if coupon.past%>å·²è¿‡æœŸ<%else if coupon.timestr==1%>
                æœ‰æ•ˆæœŸ <%coupon.timedays%>å¤©å
                <%else%>
                æœ‰æ•ˆæœŸ <%coupon.timestr%>
                <%/if%>
                <%/if%>
            </div>
            <div class="qgz2">ç‰¹åˆ«æé†’ï¼šæœ¬ä¼˜æƒ åˆ¸ä¸å¯ç”¨äºæ”¯ä»˜è¿è´¹</div>
        </div>
        <div class="qname">
            <%if coupon.coupon_goods_id>0%>
            å•å“
            <%else if coupon.enough>0%>
            è´­ç‰©
            <%else if coupon.enough<=0%>
            è´­ç‰©
            <%/if%>
            <%if coupon.backtype == 0 && coupon.enough<=0%>
            ç«‹å‡
            <%else if coupon.backtype == 0 && coupon.enough>0%>
            æ»¡å‡
            <%else if coupon.backtype == 1%>
            ğŸ’‰æ‰“æŠ˜
            <%else if coupon.backtype == 2%>
            è¿”åˆ©
            <%/if%>

        </div>
    </div>
    <%/if%>
    <!-- æ–°ç‰ˆä¼˜æƒ åˆ¸ç»“æŸ-->
    <div class="order_main" >
        <%if address%>
        <div class="line"><div class="label">æ”¶è´§äºº</div><div class="info"><div class='inner'><%address.realname%> <%address.mobile%></div></div></div>
        <div class="line"><div class="label">æ”¶è´§åœ°å€</div><div class="info"><div class='inner'><%address.provice%> <%address.city%> <%address.area%> <%address.address%></div></div></div>
        <%/if%>
        <%if carrier%>
        <%if order.isverify=='1' || order.isvirtual=='1'%>
        <div class="line"><div class="label">è”ç³»äºº</div><div class="info"><div class='inner'><%carrier.carrier_realname%></div></div></div>
        <div class="line"><div class="label">è”ç³»ç”µè¯</div><div class="info"><div class='inner'><%carrier.carrier_mobile%></div></div></div>
        <%else%>
        <div class="line"><div class="label">è‡ªæåœ°ç‚¹</div><div class="info"><div class='inner'><%carrier.address%></div></div></div>
        <div class="line"><div class="label">è‡ªæè”ç³»äºº</div><div class="info"><div class='inner'><%carrier.realname%> <%carrier.mobile%></div></div></div>
        <%/if%>
        <%/if%>
        <div class="line"><div class="label">å®ä»˜æ¬¾</div><div class="info"><div class='inner'><span style='color:#ff6600'>ï¿¥<%order.price%>å…ƒ</span></div></div></div>
        <%if order.virtual!='0'%>
        <div class="line" style='text-align:center;'>è¯·åˆ°è®¢å•ä¸­æŸ¥çœ‹ç‰©å“ä¿¡æ¯</div>
        <%/if%>
    </div>
    <div class="order_main1" >
        <span class="order_sub5" onclick="location.href='{php echo $this->createMobileUrl('order/detail')}&id=<%order.id%>'">è®¢å•è¯¦æƒ…</span>
        <span class="order_sub5" onclick="location.href='{php echo $this->createMobileUrl('shop')}'">è¿”å›é¦–é¡µ</span>
    </div>
</script>

<script id='tpl_order_cash' type='text/html'>
    <div class="page_topbar">
        <div class="title">è®¢å•æäº¤æˆåŠŸ</div>
    </div>
    <img src="../addons/manor_shop/template/mobile/default/static/images/pay_cash.png" style="width:100%;" />
    <div class="order_main" >
        <%if address%>
        <div class="line"><div class="label">æ”¶è´§äºº</div><div class="info"><div class='inner'><%address.realname%> <%address.mobile%></div></div></div>
        <div class="line"><div class="label">æ”¶è´§åœ°å€</div><div class="info"><div class='inner'><%address.address%></div></div></div>
        <%/if%>
        <%if carrier%>
        <%if order.isverify=='1' || order.isvirtual=='1'%>
        <div class="line"><div class="label">è”ç³»äºº</div><div class="info"><div class='inner'><%carrier.carrier_realname%></div></div></div>
        <div class="line"><div class="label">è”ç³»ç”µè¯</div><div class="info"><div class='inner'><%carrier.carrier_mobile%></div></div></div>
        <%else%>
        <div class="line"><div class="label">è‡ªæåœ°ç‚¹</div><div class="info"><div class='inner'><%carrier.address%></div></div></div>
        <div class="line"><div class="label">è‡ªæè”ç³»äºº</div><div class="info"><div class='inner'><%carrier.realname%> <%carrier.mobile%></div></div></div>
        <%/if%>
        <%/if%>
        <div class="line"><div class="label">éœ€åˆ°ä»˜</div><div class="info"><div class='inner'><span style='color:#ff6600'>ï¿¥<%order.price%>å…ƒ</span></div></div></div>
    </div>
    <div class="order_main1" >
        <span class="order_sub5" onclick="location.href='{php echo $this->createMobileUrl('order/detail')}&id=<%order.id%>'">è®¢å•è¯¦æƒ…</span>
        <span class="order_sub5" onclick="location.href='{php echo $this->createMobileUrl('shop')}'">è¿”å›é¦–é¡µ</span>
    </div>
</script>


<script language="javascript">
    var url = 'index.php?i='+"{$_W['acid']}"+'&c=entry';
    require(['tpl', 'core'], function(tpl, core) {
        core.json('order/pay',{orderid:'{$_GPC['orderid']}',openid:"{$openid}"},function(json){
            var result = json.result;
            if(json.status==-1){
                location.href = core.getUrl('order/detail',{id:"{$_GPC['orderid']}"});
                return;
            }
            if(json.status!=1){
                core.message(result,"{php echo $this->createMobileUrl('order/detail',array('id'=>$_GPC['orderid']))}",'error');
                return;
            }
            $('#container').html(tpl('tpl_order_info',result));

            if(result.alipay.success){

                $('.order_sub2').click(function(){

                    var deduct = ($('#deductmoney').length>0 &&$('#deductmoney').attr('on')=='1' )?1:0 ;
                    core.json('order/pay', {op: 'pay',type: 'alipay', orderid:'{$_GPC['orderid']}',openid:"{$openid}",deduct:deduct}, function (rjson) {
                        if(rjson.status!=1){
                            $('.button').removeAttr('submitting');
                            core.tip.show(rjson.result);
                            return;
                        }
                        //virtual
                        location.href = core.getUrl('order/pay_alipay',{orderid:'{$_GPC['orderid']}'});
                        return;
                    },true,true);
                })
            }
            if(result.credit.success){

                $(".order_sub3").click(function(){
                    if($(this).attr('submitting')=='1'){
                        return;
                    }
                    core.tip.confirm('ç¡®è®¤è¦ç«‹å³ä»˜æ¬¾?',function(){
                        $('.button').attr('submitting',1);
                        core.json('order/pay',{
                            op:'complete',
                            orderid:'{$_GPC['orderid']}',
                            type:'credit'
                        },function(pay_json){
                            if(pay_json.status==1){
                                if(pay_json.result.send_coupon_id>0) {
                                    core.pjson('coupon/detail', {'op': 'pay', 'id': pay_json.result.send_coupon_id}, function (coupon_ret) {
                                        if(coupon_ret.status == 1) {
                                            core.pjson('coupon/detail', {
                                                op: 'payresult',
                                                'id': pay_json.result.send_coupon_id,
                                                logid: coupon_ret.result.logid
                                            }, function (c_json) {
                                                if(pay_json.status == 1) {
                                                    pay_json.result['coupon'] = c_json.result;
                                                    console.log(pay_json);
                                                    $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                                    return;
                                                }
                                                $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                                return;
                                            }, true, true);
                                        } else {
                                            $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                            return;
                                        }
                                    }, true, true);
                                } else {
                                    $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                    return;
                                }

                            }
                            else {
                                core.tip.show(pay_json.result);
                                $('.button').removeAttr('submitting');
                            }
                        },true,true);
                    });
                });
            }

            if(result.cash.success){
                $(".order_sub6").click(function(){
                    if($(this).attr('submitting')=='1'){
                        return;
                    }
                    core.tip.confirm('ç¡®è®¤è¦è´§åˆ°ä»˜æ¬¾?',function(){
                        $('.button').attr('submitting',1);
                        core.json('order/pay',{
                            op:'complete',
                            orderid:'{$_GPC['orderid']}',
                            type:'cash'
                        },function(pay_json){
                            if(pay_json.status==2){
                                $('#container').html(tpl('tpl_order_cash',pay_json.result));
                                return;
                            }
                            core.tip.show(pay_json.result);
                            $('.button').removeAttr('submitting');
                        },true,true);
                    });})
            }

            if(result.wechat.success){
                $('.order_sub1').click(function(){
                    if($(this).attr('submitting')=='1'){
                        return;
                    }
                    $('.button').attr('submitting',1);
                    var deduct = ($('#deductmoney').length>0 &&$('#deductmoney').attr('on')=='1' )?1:0 ;
                    core.json('order/pay', {op: 'pay',type: 'weixin', orderid:'{$_GPC['orderid']}',deduct:deduct}, function (rjson) {
                        if(rjson.status!=1){
                            $('.button').removeAttr('submitting');
                            core.tip.show(rjson.result);
                            return;
                        }

                        var wechat = rjson.result.wechat;
                        WeixinJSBridge.invoke('getBrandWCPayRequest', {
                            'appId': wechat.appid ? wechat.appid : wechat.appId,
                            'timeStamp': wechat.timeStamp,
                            'nonceStr': wechat.nonceStr,
                            'package': wechat.package,
                            'signType': wechat.signType,
                            'paySign': wechat.paySign,
                        }, function (res) {
                            if (res.err_msg == 'get_brand_wcpay_request:ok') {
                                core.json('order/pay',{
                                    op:'complete',
                                    orderid:'{$_GPC['orderid']}',
                                    type:'weixin',deduct:deduct
                                },function(pay_json){
                                    if(pay_json.status==1){
                                        if(pay_json.result.send_coupon_id>0) {
                                            core.pjson('coupon/detail', {'op': 'pay', 'id': pay_json.result.send_coupon_id}, function (coupon_ret) {
                                                if(coupon_ret.status == 1) {
                                                    core.pjson('coupon/detail', {
                                                        op: 'payresult',
                                                        'id': pay_json.result.send_coupon_id,
                                                        logid: coupon_ret.result.logid
                                                    }, function (c_json) {
                                                        if(pay_json.status == 1) {
                                                            pay_json.result['coupon'] = c_json.result;
                                                            console.log(pay_json);
                                                            $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                                            return;
                                                        }
                                                        $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                                        return;
                                                    }, true, true);
                                                } else {
                                                    $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                                    return;
                                                }
                                            }, true, true);
                                        } else {
                                            $('#container').html(tpl('tpl_order_pay', pay_json.result));
                                            return;
                                        }
                                    }
                                    else {
                                        core.tip.show(pay_json.result);
                                        $('.button').removeAttr('submitting');
                                    }
                                },true,true);
                            } else if(res.err_msg=='get_brand_wcpay_request:cancel') {
                                $('.button').removeAttr('submitting');
                                core.tip.show('å–æ¶ˆæ”¯ä»˜');
                            } else {
                                $('.button').removeAttr('submitting');
                                alert(res.err_msg);
                            }
                        });
//                                require(['http://res.wx.qq.com/open/js/jweixin-1.0.0.js'],function(wx){
//                                        jssdkconfig = {php echo json_encode($_W['account']['jssdkconfig']);} || { jsApiList:[] };
//                                        jssdkconfig.debug = false;
//                                        jssdkconfig.jsApiList = ['checkJsApi','chooseWXPay'];
//                                        wx.config(jssdkconfig);
//	                      wx.ready(function () {
//                                                $('.button').removeAttr('submitting');
//                                                 var appid = wechat.appid?wechat.appid:wechat.appId;
//                                                wx.chooseWXPay({
//                                                    'appId' :  appid,
//                                                    'timestamp': wechat.timeStamp,
//                                                    'nonceStr' : wechat.nonceStr,
//                                                    'package' :  wechat.package,
//                                                    'signType' : wechat.signType,
//                                                    'paySign' : wechat.paySign,
//                                                    success: function (res) {
//                                                       
//                                                                core.json('order/pay',{
//                                                                     op:'complete',
//                                                                     orderid:'{$_GPC['orderid']}',
//                                                                     type:'weixin',deduct:deduct
//                                                                 },function(pay_json){
//                                                                     if(pay_json.status==1){
//                                                                        $('#container').html(tpl('tpl_order_pay',pay_json.result));
//                                                                        return;
//                                                                     }
//                                                                     core.tip.show(pay_json.result);
//                                                                     $('.button').removeAttr('submitting');
//                                                                 },true,true);
//                                                          
//                                                    },fail:function(res){
//                                                        alert(res.errMsg);
//                                                    }
//                                                });
//                                            });
//                              }); 
                    },true,true);
                });
            }
            $('.order_subc').click(function(){
                core.tip.confirm('ç¡®è®¤è¦ç«‹å³ä»˜æ¬¾?',function(){
                    $('.button').attr('submitting',1);
                    core.json('order/pay',{
                        op:'complete',
                        orderid:'{$_GPC['orderid']}',
                        type:'credit'
                    },function(pay_json){
                        if(pay_json.status==1){
                            if(pay_json.result.send_coupon_id>0) {
                                core.pjson('coupon/detail', {'op': 'pay', 'id': pay_json.result.send_coupon_id}, function (coupon_ret) {
                                    if(coupon_ret.status == 1) {
                                        core.pjson('coupon/detail', {
                                            op: 'payresult',
                                            'id': pay_json.result.send_coupon_id,
                                            logid: coupon_ret.result.logid
                                        }, function (c_json) {
                                            if(pay_json.status == 1) {
                                                pay_json.result['coupon'] = c_json.result;
                                                console.log(pay_json);
                                                $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                                return;
                                            }
                                            $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                            return;
                                        }, true, true);
                                    } else {
                                        $('#container').html(tpl('tpl_order_pay',pay_json.result));
                                        return;
                                    }
                                }, true, true);
                            } else {
                                $('#container').html(tpl('tpl_order_pay', pay_json.result));
                                return;
                            }
                        } else {
                            core.tip.show(pay_json.result);
                            $('.button').removeAttr('submitting');
                        }

                    },true,true);
                })
            });

        },true);

    });
    if(window.history.length==1){//åˆ¤æ–­æ˜¯ç¬¬ä¸€æ¬¡ä»å¾®ä¿¡èœå•è¿›å…¥é¡µé¢
        //å†™å…¥ç©ºç™½å†å²è®°å½•
        pushHistory();

    }

    //å»¶æ—¶ç›‘å¬
    setTimeout(function () {
        //ç›‘å¬ç‰©ç†è¿”å›æŒ‰é’®
        window.addEventListener("popstate", function(e) {
            WeixinJSBridge.call('closeWindow');
        }, false);

    }, 300);
    /**
     * [pushHistory å†™å…¥ç©ºç™½å†å²è®°å½•]
     * @author é‚±å…ˆç”Ÿ
     * @copyright çƒŸç«é‡Œçš„å°˜åŸƒ
     * @version [V1.0ç‰ˆæœ¬]
     * @date 2016-07-30
     * @return {[type]} [description]
     */
    function pushHistory() {
        var state = {
            title: "title",
            url: "#"
        };
        window.history.pushState(state, "title", "#");
    }

</script>
{template 'common/footer'}